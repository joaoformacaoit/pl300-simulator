<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PL-300 Exam Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Base Layout & Fonts --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        /* --- Header & Progress Bar --- */
        .header {
            background-color: #ffffff;
            color: #333;
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h2 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }
        .timer {
            background-color: #0078d4;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #0078d4;
            transition: width 0.3s ease;
        }

        /* --- Content Area (Questions/Results) --- */
        .content {
            padding: 30px;
            min-height: 350px;
        }
        .question-text {
            font-size: 1.4em;
            font-weight: 500;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        /* --- Options List --- */
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .option-item {
            background-color: #f7f9fc;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .option-item:hover {
            background-color: #eaf1f7;
            border-color: #0078d4;
        }
        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .option-item label {
            display: block;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 400;
            user-select: none; /* Prevent text selection on click */
        }

        /* --- Footer & Navigation --- */
        .footer {
            padding: 15px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #prev-btn {
            background-color: #f0f2f5;
            color: #333;
        }
        #prev-btn:hover {
            background-color: #e0e2e5;
        }
        #next-btn, #finish-btn {
            background-color: #0078d4;
            color: white;
            margin-left: 10px;
        }
        #next-btn:hover, #finish-btn:hover {
            background-color: #005a9e;
        }
        #finish-btn {
            background-color: #107c10; /* Green for finish */
        }
        #finish-btn:hover {
            background-color: #0c6a0c;
        }

        /* --- Question Pager (1, 2, 3...) --- */
        .pager {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .pager-item {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #333;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pager-item.active {
            background-color: #0078d4;
            color: white;
            font-weight: bold;
        }
        .pager-item.answered {
            background-color: #d1e7dd; /* Light green */
        }
        .pager-item.active.answered {
            background-color: #0078d4; /* Keep blue for active */
        }

        /* --- Results/Feedback --- */
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1em;
            display: none; /* Initially hidden */
        }
        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .explanation {
            margin-top: 10px;
            font-size: 0.95em;
            font-style: italic;
        }
        .topic-level {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        /* --- Welcome/Start Screen --- */
        #start-screen {
            text-align: center;
            padding: 50px 30px;
        }
        #start-screen h1 {
            font-size: 2em;
            color: #0078d4;
            margin-bottom: 5px;
        }
        #start-screen p {
            color: #6c757d;
            margin-bottom: 30px;
        }
        .info-list {
            list-style: none;
            padding: 0;
            margin: 30px 0;
            text-align: left;
            display: inline-block;
        }
        .info-list li {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
        }
        .info-list i {
            color: #107c10;
            margin-right: 10px;
        }
        #start-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #start-btn:hover {
            background-color: #005a9e;
        }

        /* --- Final Results Screen --- */
        #final-results-screen {
            text-align: center;
            padding: 50px 30px;
        }
        #final-results-screen h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #final-results-screen .score-summary {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .score-box {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 150px;
        }
        .score-box h3 {
            font-size: 2em;
            margin: 0 0 5px 0;
        }
        .score-box p {
            margin: 0;
            font-weight: 500;
        }
        .score-box.correct { background-color: #d1e7dd; color: #0f5132; }
        .score-box.incorrect { background-color: #f8d7da; color: #842029; }
        .score-box.total { background-color: #cce5ff; color: #004085; }
        
        .result-review-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            text-align: left;
            position: relative;
        }
        .result-review-item.correct-answer { background-color: #e9f5e9; }
        .result-review-item.incorrect-answer { background-color: #fcebeb; }
        .review-q-text { font-weight: bold; margin-bottom: 5px; }
        .review-explanation { font-style: italic; font-size: 0.9em; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;}
        .review-status-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5em;
        }
        .review-status-icon.correct { color: #107c10; }
        .review-status-icon.incorrect { color: #dc3545; }


    </style>
</head>
<body>

    <div class="container">
        <div class="header" id="quiz-header" style="display: none;">
            <h2 id="exam-title">Exame PL-300</h2>
            <div class="timer" id="timer-display"><i class="fas fa-clock"></i> 59:47</div>
        </div>
        <div class="progress-bar-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="content">
            <div id="start-screen">
                <i class="fas fa-check-circle" style="font-size: 4em; color: #0078d4; margin-bottom: 20px;"></i>
                <h1>Simulador de Exame PL-300</h1>
                <p>Microsoft Power BI Data Analyst</p>
                
                <h2>Informações do Exame:</h2>
                <ul class="info-list">
                    <li><i class="fas fa-check-circle"></i> **10 questões** de escolha múltipla (Aumente o número no código!)</li>
                    <li><i class="fas fa-check-circle"></i> **60 minutos** para completar</li>
                    <li><i class="fas fa-check-circle"></i> As questões podem ter **uma ou mais** respostas corretas.</li>
                    <li><i class="fas fa-check-circle"></i> Pontuação mínima para aprovação: **70%**</li>
                </ul>
                
                <button id="start-btn">Iniciar Exame</button>
            </div>

            <div id="quiz-screen" style="display: none;">
                <div id="question-text" class="question-text"></div>
                <ul class="options-list" id="options-list"></ul>
                <div class="feedback" id="feedback-message"></div>
                
                <div style="text-align: right; margin-top: 10px;">
                    <i id="flag-icon" class="fas fa-flag" style="color: #6c757d; cursor: pointer;" title="Marcar para Revisão"></i>
                </div>
            </div>

            <div id="final-results-screen" style="display: none;">
                <h2 id="pass-fail-status">Não Aprovado</h2>
                <p id="final-score-text">Pontuação Final: 10%</p>
                <div class="score-summary">
                    <div class="score-box correct">
                        <h3 id="correct-count">1</h3>
                        <p>Corretas</p>
                    </div>
                    <div class="score-box incorrect">
                        <h3 id="incorrect-count">9</h3>
                        <p>Incorretas</p>
                    </div>
                    <div class="score-box total">
                        <h3 id="total-count">10</h3>
                        <p>Total</p>
                    </div>
                </div>
                
                <h3>Revisão de Respostas:</h3>
                <div id="review-list">
                    </div>
            </div>
            
        </div>

        <div class="footer" id="quiz-footer" style="display: none;">
            <div class="nav-buttons">
                <button id="prev-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Anterior</button>
            </div>
            <div class="pager" id="pager-container">
                </div>
            <div class="nav-buttons">
                <button id="next-btn">Próxima <i class="fas fa-arrow-right"></i></button>
                <button id="finish-btn" style="display: none;"><i class="fas fa-check-circle"></i> Terminar Exame</button>
            </div>
        </div>

    </div>

    <script>
        const quizQuestions = [
            // Question 1: Data Preparation (Import/DirectQuery)
            {
                id: 1,
                topic: "Data Preparation",
                level: "Intermediate",
                question: "Qual o modo de conectividade que **não** carrega dados para o Power BI Desktop, mantendo a fonte de dados como a única verdade?",
                options: [
                    "Import",
                    "DirectQuery",
                    "Dual",
                    "Composite"
                ],
                correctAnswers: [1], // DirectQuery
                explanation: "**DirectQuery** é o modo que consulta diretamente a fonte de dados (como SQL Server) em tempo real, sem carregar os dados para o modelo do Power BI Desktop. Import carrega dados, e Dual/Composite são modos híbridos."
            },
            // Question 2: Data Modeling (Relationships)
            {
                id: 2,
                topic: "Data Modeling",
                level: "Basic",
                question: "Que tipo de relação deve ser criada entre uma tabela de **factos** (Fact Table) e uma tabela de **dimensão** (Dimension Table) num modelo 'Star Schema' típico?",
                options: [
                    "Muitos para muitos (Many-to-Many)",
                    "Um para um (One-to-One)",
                    "Um para muitos (One-to-Many)",
                    "Nenhuma relação é necessária"
                ],
                correctAnswers: [2], // One-to-Many (Dimension -> Fact)
                explanation: "A relação correta é **Um para Muitos (1:*)**, onde o lado 'Um' (1) está na tabela de dimensão (e.g., Clientes) e o lado 'Muitos' (*) na tabela de factos (e.g., Vendas)."
            },
            // Question 3: DAX (Time Intelligence) - Multi-select
            {
                id: 3,
                topic: "DAX",
                level: "Advanced",
                question: "Para calcular as **Vendas Acumuladas no Ano (Year-To-Date - YTD)**, quais das seguintes funções DAX podem ser utilizadas de forma eficaz? (Selecione **DUAS** respostas)",
                options: [
                    "CALCULATE",
                    "SUMMARIZE",
                    "TOTALYTD",
                    "CALCULATETABLE"
                ],
                correctAnswers: [0, 2], // CALCULATE and TOTALYTD
                explanation: "A função **TOTALYTD** (index 2) é uma função de inteligência de tempo simplificada. Alternativamente, a função **CALCULATE** (index 0) pode ser usada em conjunto com `DATESYTD` para conseguir o mesmo resultado, sendo fundamental para mudar o contexto de filtro."
            },
            // Question 4: Data Transformation (Power Query)
            {
                id: 4,
                topic: "Data Transformation",
                level: "Intermediate",
                question: "Qual das seguintes operações no Power Query é usada para transformar dados onde múltiplas colunas representam valores da mesma variável (formato 'wide') para um formato onde cada variável tem uma única coluna (formato 'tall' ou 'unpivoted')?",
                options: [
                    "Merge Queries",
                    "Append Queries",
                    "Group By",
                    "Unpivot Columns"
                ],
                correctAnswers: [3], // Unpivot Columns
                explanation: "**Unpivot Columns** (Desinverter Colunas) é a operação usada para passar de um formato 'wide' (largo) para um formato 'tall' (alto), que é o ideal para a modelação no Power BI (Princípios Tidy Data)."
            },
            // Question 5: Visualization
            {
                id: 5,
                topic: "Visualization and Analysis",
                level: "Intermediate",
                question: "Qual tipo de visualização é o mais apropriado para mostrar a **distribuição de dados e a identificação de outliers**?",
                options: [
                    "Line Chart (Gráfico de Linhas)",
                    "Pie Chart (Gráfico Circular)",
                    "Box and Whisker Plot (Diagrama de Extremos e Quartis)",
                    "Stacked Bar Chart (Gráfico de Barras Empilhadas)"
                ],
                correctAnswers: [2], // Box and Whisker Plot
                explanation: "O **Box and Whisker Plot** (index 2) é ideal para visualizar a mediana, quartis, dispersão e, crucialmente, os **outliers** (pontos fora dos 'whiskers') de uma distribuição de dados."
            },
            // Question 6: Security and Deployment (RLS)
            {
                id: 6,
                topic: "Deployment and Maintenance",
                level: "Advanced",
                question: "Qual é o principal mecanismo usado para restringir o acesso aos dados dentro de um relatório do Power BI para utilizadores específicos, com base nas suas credenciais ou funções?",
                options: [
                    "Row-Level Security (RLS)",
                    "Object-Level Security (OLS)",
                    "Setting permissions on the Gateway",
                    "Defining a Workspace Security Group"
                ],
                correctAnswers: [0], // Row-Level Security (RLS)
                explanation: "**Row-Level Security (RLS)** (Segurança ao Nível da Linha) é o método principal para filtrar as linhas de dados que um utilizador pode ver num relatório publicado, geralmente utilizando funções DAX."
            },
            // Question 7: Data Modeling (Cross-Filter Direction)
            {
                id: 7,
                topic: "Data Modeling",
                level: "Advanced",
                question: "Numa relação One-to-Many entre Tabela A (1) e Tabela B (*), a direção de filtro padrão é **Single**. Se pretender que os filtros aplicados à Tabela B filtrem a Tabela A, qual configuração deve ser alterada?",
                options: [
                    "Cardinality: One-to-One",
                    "Cross-filter direction: Both",
                    "Data load: DirectQuery",
                    "Relationship is Active"
                ],
                correctAnswers: [1], // Cross-filter direction: Both
                explanation: "Mudar a **direção de filtro cruzado (Cross-filter direction)** para **Both** (Ambas) permite que os filtros fluam em ambas as direções da relação, possibilitando que a Tabela B filtre a Tabela A (apesar de esta prática dever ser usada com cautela)."
            },
            // Question 8: DAX (Context Transition)
            {
                id: 8,
                topic: "DAX",
                level: "Advanced",
                question: "Em DAX, quando a função `CALCULATE` é usada dentro de uma Coluna Calculada, ocorre um fenómeno que converte o Contexto de Linha (Row Context) para Contexto de Filtro (Filter Context) no início da avaliação. Qual é o nome deste fenómeno?",
                options: [
                    "Filter Propagation",
                    "Context Transition",
                    "Relationship Activation",
                    "Query Folding"
                ],
                correctAnswers: [1], // Context Transition
                explanation: "Este é o conceito fundamental de **Context Transition** (Transição de Contexto), onde a `CALCULATE` converte implicitamente o contexto de linha para contexto de filtro, avaliando a expressão para o contexto de filtro criado por essa linha."
            },
            // Question 9: Data Preparation (Query Folding)
            {
                id: 9,
                topic: "Data Transformation",
                level: "Intermediate",
                question: "Qual o benefício principal de conseguir o **Query Folding** (Dobragem de Consulta) no Power Query, especialmente ao trabalhar com grandes fontes de dados relacionais?",
                options: [
                    "Permite a criação de visuais personalizados no relatório.",
                    "Aumenta a portabilidade do modelo para a Cloud.",
                    "Melhora o desempenho ao delegar o processamento de transformação à fonte de dados.",
                    "É necessário para usar o modo DirectQuery."
                ],
                correctAnswers: [2], // Improves performance by delegating processing
                explanation: "**Query Folding** melhora o desempenho ao traduzir os passos M do Power Query para a linguagem da fonte de dados (e.g., SQL) e executá-los lá, reduzindo a quantidade de dados que precisam de ser transferidos e processados pelo Power BI."
            },
            // Question 10: Deployment and Maintenance (Workspaces) - Multi-select
            {
                id: 10,
                topic: "Deployment and Maintenance",
                level: "Intermediate",
                question: "Quais das seguintes são **funcionalidades principais** dos Workspaces (Áreas de Trabalho) no serviço Power BI? (Selecione **DUAS** respostas)",
                options: [
                    "Servir como contentor para Dashboards, Relatórios e Datasets.",
                    "Permitir o desenvolvimento de modelos em Power BI Desktop.",
                    "Definir a segurança ao nível da linha (RLS).",
                    "Colaboração e gestão de acesso para equipas."
                ],
                correctAnswers: [0, 3], // Container and Collaboration/Access Management
                explanation: "Workspaces são primariamente contentores no serviço (index 0) e o ponto central para **colaboração e gestão de acesso** (index 3). O desenvolvimento é feito no Desktop (fora do Workspace), e o RLS é definido no modelo (dataset)."
            },
        ];

        // --- GLOBAL STATE ---
        let currentQuestionIndex = 0;
        let userAnswers = []; // Store selected options for each question
        let isFlagged = new Array(quizQuestions.length).fill(false);
        let timerSeconds = 60 * 60; // 60 minutes
        let timerInterval;

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const finalResultsScreen = document.getElementById('final-results-screen');
        const quizHeader = document.getElementById('quiz-header');
        const progressContainer = document.getElementById('progress-container');
        const quizFooter = document.getElementById('quiz-footer');
        
        const questionText = document.getElementById('question-text');
        const optionsList = document.getElementById('options-list');
        const feedbackMessage = document.getElementById('feedback-message');
        const progressBar = document.getElementById('progress-bar');
        const timerDisplay = document.getElementById('timer-display');
        const pagerContainer = document.getElementById('pager-container');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const finishBtn = document.getElementById('finish-btn');
        const flagIcon = document.getElementById('flag-icon');

        // --- EVENT LISTENERS ---
        document.getElementById('start-btn').addEventListener('click', startExam);
        nextBtn.addEventListener('click', () => navigateQuestion(1));
        prevBtn.addEventListener('click', () => navigateQuestion(-1));
        finishBtn.addEventListener('click', showFinalResults);
        flagIcon.addEventListener('click', toggleFlag);


        // --- MAIN FUNCTIONS ---

        function startExam() {
            startScreen.style.display = 'none';
            quizScreen.style.display = 'block';
            quizHeader.style.display = 'flex';
            progressContainer.style.display = 'block';
            quizFooter.style.display = 'flex';
            
            // Initialize user answers array
            userAnswers = quizQuestions.map(() => []);

            // Setup pager
            createPager();

            // Load first question
            loadQuestion(0);

            // Start timer
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timerSeconds--;
                if (timerSeconds < 0) {
                    clearInterval(timerInterval);
                    timerDisplay.innerHTML = `<i class="fas fa-clock"></i> 00:00`;
                    showFinalResults();
                    return;
                }
                const minutes = Math.floor(timerSeconds / 60);
                const seconds = timerSeconds % 60;
                timerDisplay.innerHTML = `<i class="fas fa-clock"></i> ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const q = quizQuestions[index];

            // 1. Update Header & Progress
            document.getElementById('exam-title').textContent = `Exame PL-300 | Questão ${index + 1} de ${quizQuestions.length}`;
            progressBar.style.width = `${((index + 1) / quizQuestions.length) * 100}%`;
            
            // 2. Update Question Content
            const isMultiSelect = q.correctAnswers.length > 1;
            const selectionText = isMultiSelect ? '(Selecione **todas** as corretas)' : '(Selecione **uma** correta)';
            
            questionText.innerHTML = `${q.question} <span style="font-size:0.7em; color:#888;">${selectionText}</span>`;
            
            // 3. Render Options
            optionsList.innerHTML = '';
            const inputType = isMultiSelect ? 'checkbox' : 'radio';
            
            q.options.forEach((option, i) => {
                const item = document.createElement('li');
                item.classList.add('option-item');
                
                const isChecked = userAnswers[index].includes(i);

                item.innerHTML = `
                    <label>
                        <input type="${inputType}" name="answer-option" value="${i}" ${isChecked ? 'checked' : ''} onchange="saveAnswer(${index}, ${i}, '${inputType}')">
                        ${option}
                    </label>
                `;
                optionsList.appendChild(item);
            });

            // 4. Update Navigation
            prevBtn.style.display = (index > 0) ? 'block' : 'none';
            nextBtn.style.display = (index < quizQuestions.length - 1) ? 'block' : 'none';
            finishBtn.style.display = (index === quizQuestions.length - 1) ? 'block' : 'none';
            
            // 5. Update Pager State
            updatePager();
            
            // 6. Update Flag
            updateFlagIcon(index);

            // 7. Clear Feedback
            feedbackMessage.style.display = 'none'; // Feedback is only shown after exam finish/review
        }

        function createPager() {
            pagerContainer.innerHTML = '';
            for (let i = 0; i < quizQuestions.length; i++) {
                const item = document.createElement('div');
                item.classList.add('pager-item');
                item.textContent = i + 1;
                item.dataset.index = i;
                item.addEventListener('click', () => loadQuestion(i));
                pagerContainer.appendChild(item);
            }
        }

        function updatePager() {
            const pagerItems = document.querySelectorAll('.pager-item');
            pagerItems.forEach((item, i) => {
                item.classList.remove('active', 'answered', 'flagged');
                if (i === currentQuestionIndex) {
                    item.classList.add('active');
                }
                if (userAnswers[i].length > 0) {
                    item.classList.add('answered');
                }
                if (isFlagged[i]) {
                    item.style.backgroundColor = '#ffc107'; // Yellow for flagged
                } else if (item.classList.contains('active')) {
                    item.style.backgroundColor = '#0078d4';
                } else if (item.classList.contains('answered')) {
                    item.style.backgroundColor = '#d1e7dd';
                } else {
                    item.style.backgroundColor = '#e0e0e0';
                }
            });
        }

        function saveAnswer(qIndex, optionIndex, inputType) {
            let answers = userAnswers[qIndex];
            
            if (inputType === 'radio') {
                // Clear all and set new answer for radio buttons
                userAnswers[qIndex] = [optionIndex];
            } else if (inputType === 'checkbox') {
                // Toggle for checkboxes
                const indexInArray = answers.indexOf(optionIndex);
                if (indexInArray > -1) {
                    answers.splice(indexInArray, 1); // Remove
                } else {
                    answers.push(optionIndex); // Add
                }
                userAnswers[qIndex] = answers;
            }
            
            updatePager(); // Mark question as answered
        }

        function navigateQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < quizQuestions.length) {
                loadQuestion(newIndex);
            }
        }
        
        function toggleFlag() {
            isFlagged[currentQuestionIndex] = !isFlagged[currentQuestionIndex];
            updateFlagIcon(currentQuestionIndex);
            updatePager();
        }

        function updateFlagIcon(index) {
            if (isFlagged[index]) {
                flagIcon.style.color = '#ffc107'; // Yellow when flagged
            } else {
                flagIcon.style.color = '#6c757d'; // Gray/Default when not flagged
            }
        }


        function showFinalResults() {
            clearInterval(timerInterval);

            quizScreen.style.display = 'none';
            quizHeader.style.display = 'none';
            progressContainer.style.display = 'none';
            quizFooter.style.display = 'none';
            finalResultsScreen.style.display = 'block';

            let correctCount = 0;
            const totalQuestions = quizQuestions.length;
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';

            // 1. Calculate Score
            quizQuestions.forEach((q, i) => {
                const userSelection = userAnswers[i].sort((a, b) => a - b);
                const correctSelection = q.correctAnswers.sort((a, b) => a - b);

                // Compare arrays for correctness
                const isCorrect = userSelection.length === correctSelection.length && 
                                  userSelection.every((val, index) => val === correctSelection[index]);

                if (isCorrect) {
                    correctCount++;
                }

                // 2. Generate Review Item
                const reviewItem = document.createElement('div');
                reviewItem.classList.add('result-review-item');
                reviewItem.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');

                const statusIconHtml = isCorrect 
                    ? '<i class="fas fa-check-circle review-status-icon correct"></i>'
                    : '<i class="fas fa-times-circle review-status-icon incorrect"></i>';

                const userAnswerText = userSelection.length > 0 
                    ? userSelection.map(idx => `**${q.options[idx]}**`).join(' | ')
                    : '*Não Respondida*';
                
                const correctAnswerText = correctSelection.map(idx => `**${q.options[idx]}**`).join(' | ');

                reviewItem.innerHTML = `
                    ${statusIconHtml}
                    <div class="review-q-text">Questão ${i + 1}: ${q.question}</div>
                    <p>
                        **Sua Resposta:** ${userAnswerText}
                        ${!isCorrect ? '<br>**Resposta Correta:** ' + correctAnswerText : ''}
                    </p>
                    <div class="review-explanation">
                        **Explicação:** ${q.explanation}
                    </div>
                `;
                reviewList.appendChild(reviewItem);
            });

            // 3. Display Final Score
            const finalScorePercentage = Math.round((correctCount / totalQuestions) * 100);
            const isApproved = finalScorePercentage >= 70;

            document.getElementById('pass-fail-status').textContent = isApproved ? 'Aprovado' : 'Não Aprovado';
            document.getElementById('pass-fail-status').style.color = isApproved ? '#107c10' : '#dc3545';
            
            document.getElementById('final-score-text').textContent = `Pontuação Final: ${finalScorePercentage}%`;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = totalQuestions - correctCount;
            document.getElementById('total-count').textContent = totalQuestions;

            document.querySelector('.score-box.correct h3').parentElement.classList.toggle('correct', correctCount > 0);
            document.querySelector('.score-box.incorrect h3').parentElement.classList.toggle('incorrect', totalQuestions - correctCount > 0);
        }

    </script>

</body>
</html>
